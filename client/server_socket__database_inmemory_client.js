"use strict";var __extends=this&&this.__extends||function(){var r=function(t,n){return(r=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,n){t.__proto__=n}:function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])}))(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function e(){this.constructor=t}r(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}}(),__awaiter=this&&this.__awaiter||function(t,c,u,a){return new(u=u||Promise)(function(e,n){function r(t){try{i(a.next(t))}catch(t){n(t)}}function o(t){try{i(a.throw(t))}catch(t){n(t)}}function i(t){var n;t.done?e(t.value):((n=t.value)instanceof u?n:new u(function(t){t(n)})).then(r,o)}i((a=a.apply(t,c||[])).next())})},__generator=this&&this.__generator||function(r,o){var i,c,u,a={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]},s={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function t(e){return function(t){var n=[e,t];if(i)throw new TypeError("Generator is already executing.");for(;a=s&&n[s=0]?0:a;)try{if(i=1,c&&(u=2&n[0]?c.return:n[0]?c.throw||((u=c.return)&&u.call(c),0):c.next)&&!(u=u.call(c,n[1])).done)return u;switch(c=0,(n=u?[2&n[0],u.value]:n)[0]){case 0:case 1:u=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,c=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(!(u=0<(u=a.trys).length&&u[u.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!u||n[1]>u[0]&&n[1]<u[3]))a.label=n[1];else if(6===n[0]&&a.label<u[1])a.label=u[1],u=n;else{if(!(u&&a.label<u[2])){u[2]&&a.ops.pop(),a.trys.pop();continue}a.label=u[2],a.ops.push(n)}}n=o.call(r,a)}catch(t){n=[6,t],c=0}finally{i=u=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}}},events_1=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.ServerSocketDatabaseInMemoryClient=void 0,require("events")),util_1=require("util"),ServerSocketDatabaseInMemoryClient=function(o){function t(t,n,e){var r=o.call(this)||this;return r.net=require("net"),r.isAuthenticated=!1,r.port=t,r.host=n||"127.0.0.1",r.password=e,r.client=r.connect(),r.writeAsync=(0,util_1.promisify)(r.client.write.bind(r.client)),r}return __extends(t,o),t.prototype.connect=function(){var t=this;return this.client=this.net.createConnection({port:this.port,host:this.host}),this.client.setTimeout(0),this.client.on("data",this.onData.bind(this)),this.client.on("end",this.onEnd.bind(this)),this.client.on("error",this.onError.bind(this)),setTimeout(function(){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.ping("ping")];case 1:return t.sent(),[2]}})})},1e3),this.client},t.prototype.onData=function(t){this.emit("response",t.toString().trim())},t.prototype.onEnd=function(){this.isAuthenticated=!1,this.reconnect()},t.prototype.onError=function(t){this.isAuthenticated=!1,t.code,this.reconnect()},t.prototype.reconnect=function(){var t=this;setTimeout(function(){t.connect()},3e3)},t.prototype.authenticate=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return!this.password||this.isAuthenticated?[3,2]:[4,this.sendCommand("AUTH ".concat(this.password))];case 1:if("OK"!==t.sent())throw new Error("Authentication failed");this.isAuthenticated=!0,t.label=2;case 2:return[2]}})})},t.prototype.sendCommand=function(t){var e=this;return new Promise(function(n){e.once("response",function(t){n(t)}),e.client.write(t+"\n")})},t.prototype.close=function(){this.client.end()},t.prototype.isConnected=function(){return!this.client.destroyed},t.prototype.data_backup=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("DATA_BACKUP")]})})},t.prototype.data_restore=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("DATA_RESTORE")]})})},t.prototype.arr_new=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("A_NEW ".concat(n))]})})},t.prototype.arr_pop=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("A_POP ".concat(n))]})})},t.prototype.arr_push=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("A_PUSH ".concat(n," ").concat(e))]})})},t.prototype.arr_shift=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("A_SHIFT ".concat(n))]})})},t.prototype.arr_unshift=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("A_UNSHIFT ".concat(n," ").concat(e))]})})},t.prototype.arr_sort=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("A_SORT ".concat(n))]})})},t.prototype.arr_sort_c=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("A_SORT_C ".concat(n," ").concat(e))]})})},t.prototype.del=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("DEL ".concat(n))]})})},t.prototype.exists=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("EXISTS ".concat(n))]})})},t.prototype.expire=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("EXPIRE ".concat(n," ").concat(e))]})})},t.prototype.flushAll=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("FLUSHALL")]})})},t.prototype.get=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("GET ".concat(n))]})})},t.prototype.set=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("SET ".concat(n," ").concat(e))]})})},t.prototype.set_cb=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("SET_CB ".concat(n," ").concat(e))]})})},t.prototype.set_cbf=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("SET_CBF ".concat(n," ").concat(e))]})})},t.prototype.set_cf=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("SET_CF ".concat(n," ").concat(e))]})})},t.prototype.keys=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("KEYS ".concat(n))]})})},t.prototype.obj_new=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("O_NEW ".concat(n))]})})},t.prototype.obj_get=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("O_GET ".concat(n," ").concat(e))]})})},t.prototype.obj_get_del=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("O_GET_SET ".concat(n," ").concat(e))]})})},t.prototype.obj_set=function(n,e,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("O_SET ".concat(n," ").concat(e," ").concat(r))]})})},t.prototype.obj_sort_c=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("O_SORT_C ".concat(n," ").concat(e))]})})},t.prototype.ping=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("PING ".concat(n))]})})},t.prototype.ttl=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.sendCommand("TTL ".concat(n))]})})},t}(events_1.EventEmitter);exports.ServerSocketDatabaseInMemoryClient=ServerSocketDatabaseInMemoryClient;