"use strict";var __extends=this&&this.__extends||function(){var r=function(t,e){return(r=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,e){t.__proto__=e}:function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}))(t,e)};return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}(),__awaiter=this&&this.__awaiter||function(t,a,s,c){return new(s=s||Promise)(function(n,e){function r(t){try{i(c.next(t))}catch(t){e(t)}}function o(t){try{i(c.throw(t))}catch(t){e(t)}}function i(t){var e;t.done?n(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(r,o)}i((c=c.apply(t,a||[])).next())})},__generator=this&&this.__generator||function(r,o){var i,a,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},u={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function t(n){return function(t){var e=[n,t];if(i)throw new TypeError("Generator is already executing.");for(;c=u&&e[u=0]?0:c;)try{if(i=1,a&&(s=2&e[0]?a.return:e[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,e[1])).done)return s;switch(a=0,(e=s?[2&e[0],s.value]:e)[0]){case 0:case 1:s=e;break;case 4:return c.label++,{value:e[1],done:!1};case 5:c.label++,a=e[1],e=[0];continue;case 7:e=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){c=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3]))c.label=e[1];else if(6===e[0]&&c.label<s[1])c.label=s[1],s=e;else{if(!(s&&c.label<s[2])){s[2]&&c.ops.pop(),c.trys.pop();continue}c.label=s[2],c.ops.push(e)}}e=o.call(r,c)}catch(t){e=[6,t],a=0}finally{i=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}}},events_1=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.ServerSocketDatabaseInMemoryClient=void 0,require("events")),util_1=require("util"),ServerSocketDatabaseInMemoryClient=function(o){function t(t,e,n){var r=o.call(this)||this;return r.net=require("net"),r.isAuthenticated=!1,r.port=t,r.host=e||"127.0.0.1",r.password=n,r.client=r.net.createConnection({port:r.port,host:r.host}),r.client.setTimeout(0),r.client.on("data",r.onData.bind(r)),r.client.on("end",r.onEnd.bind(r)),r.client.on("error",r.onError.bind(r)),r.writeAsync=(0,util_1.promisify)(r.client.write.bind(r.client)),r}return __extends(t,o),t.prototype.onData=function(t){this.emit("response",t.toString().trim())},t.prototype.onEnd=function(){console.log("Disconnected from server"),this.isAuthenticated=!1},t.prototype.onError=function(t){console.error(t.message,t.stack,this)},t.prototype.authenticate=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return!this.password||this.isAuthenticated?[3,2]:[4,this.sendCommand("AUTH ".concat(this.password))];case 1:if("OK"!==t.sent())throw new Error("Authentication failed");this.isAuthenticated=!0,t.label=2;case 2:return[2]}})})},t.prototype.sendCommand=function(t){var n=this;return new Promise(function(e){n.once("response",function(t){e(t)}),n.client.write(t+"\n")})},t.prototype.close=function(){this.client.end()},t.prototype.data_backup=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("DATA_BACKUP")]}})})},t.prototype.data_restore=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("DATA_RESTORE")]}})})},t.prototype.del=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("DEL ".concat(e))]}})})},t.prototype.exists=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("EXISTS ".concat(e))]}})})},t.prototype.expire=function(e,n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("EXPIRE ".concat(e," ").concat(n))]}})})},t.prototype.flushAll=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("FLUSHALL")]}})})},t.prototype.get=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("GET ".concat(e))]}})})},t.prototype.set=function(e,n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("SET ".concat(e," ").concat(n))]}})})},t.prototype.set_cb=function(e,n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("SET_CB ".concat(e," ").concat(n))]}})})},t.prototype.keys=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("KEYS ".concat(e))]}})})},t.prototype.ttl=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("TTL ".concat(e))]}})})},t}(events_1.EventEmitter);exports.ServerSocketDatabaseInMemoryClient=ServerSocketDatabaseInMemoryClient;