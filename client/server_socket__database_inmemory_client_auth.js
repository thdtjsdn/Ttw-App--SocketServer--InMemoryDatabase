"use strict";var __extends=this&&this.__extends||function(){var r=function(t,n){return(r=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,n){t.__proto__=n}:function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])}))(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function e(){this.constructor=t}r(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}}(),__awaiter=this&&this.__awaiter||function(t,a,c,s){return new(c=c||Promise)(function(e,n){function r(t){try{o(s.next(t))}catch(t){n(t)}}function i(t){try{o(s.throw(t))}catch(t){n(t)}}function o(t){var n;t.done?e(t.value):((n=t.value)instanceof c?n:new c(function(t){t(n)})).then(r,i)}o((s=s.apply(t,a||[])).next())})},__generator=this&&this.__generator||function(r,i){var o,a,c,s={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]},u={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function t(e){return function(t){var n=[e,t];if(o)throw new TypeError("Generator is already executing.");for(;s=u&&n[u=0]?0:s;)try{if(o=1,a&&(c=2&n[0]?a.return:n[0]?a.throw||((c=a.return)&&c.call(a),0):a.next)&&!(c=c.call(a,n[1])).done)return c;switch(a=0,(n=c?[2&n[0],c.value]:n)[0]){case 0:case 1:c=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,a=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(c=0<(c=s.trys).length&&c[c.length-1])&&(6===n[0]||2===n[0])){s=0;continue}if(3===n[0]&&(!c||n[1]>c[0]&&n[1]<c[3]))s.label=n[1];else if(6===n[0]&&s.label<c[1])s.label=c[1],c=n;else{if(!(c&&s.label<c[2])){c[2]&&s.ops.pop(),s.trys.pop();continue}s.label=c[2],s.ops.push(n)}}n=i.call(r,s)}catch(t){n=[6,t],a=0}finally{o=c=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}}},events_1=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.ServerSocketDatabaseInMemoryClientAuth=void 0,require("events")),util_1=require("util"),ServerSocketDatabaseInMemoryClientAuth=function(i){function t(t,n,e){var r=i.call(this)||this;return r.net=require("net"),r.isAuthenticated=!1,r.port=t,r.host=n||"127.0.0.1",r.password=e,r.client=r.connect(),r.writeAsync=(0,util_1.promisify)(r.client.write.bind(r.client)),r}return __extends(t,i),t.prototype.connect=function(){var t=this;return this.client=this.net.createConnection({port:this.port,host:this.host}),this.client.setTimeout(0),this.client.on("data",this.onData.bind(this)),this.client.on("end",this.onEnd.bind(this)),this.client.on("error",this.onError.bind(this)),setTimeout(function(){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.ping("ping")];case 1:return t.sent(),[2]}})})},1e3),this.client},t.prototype.onData=function(t){this.emit("response",t.toString().trim())},t.prototype.onEnd=function(){this.isAuthenticated=!1,this.reconnect()},t.prototype.onError=function(t){this.isAuthenticated=!1,t.code,this.reconnect()},t.prototype.reconnect=function(){var t=this;setTimeout(function(){t.connect()},3e3)},t.prototype.authenticate=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return!this.password||this.isAuthenticated?[3,2]:[4,this.sendCommand("AUTH ".concat(this.password))];case 1:if("OK"!==t.sent())throw new Error("Authentication failed");this.isAuthenticated=!0,t.label=2;case 2:return[2]}})})},t.prototype.sendCommand=function(t){var e=this;return new Promise(function(n){e.once("response",function(t){n(t)}),e.client.write(t+"\n")})},t.prototype.close=function(){this.client.end()},t.prototype.isConnected=function(){return!this.client.destroyed},t.prototype.data_backup=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("DATA_BACKUP")]}})})},t.prototype.data_restore=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("DATA_RESTORE")]}})})},t.prototype.arr_new=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("A_NEW ".concat(n))]}})})},t.prototype.arr_pop=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("A_POP ".concat(n))]}})})},t.prototype.arr_push=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("A_PUSH ".concat(n," ").concat(e))]}})})},t.prototype.arr_shift=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("A_SHIFT ".concat(n))]}})})},t.prototype.arr_unshift=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("A_UNSHIFT ".concat(n," ").concat(e))]}})})},t.prototype.arr_sort=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("A_SORT ".concat(n))]}})})},t.prototype.arr_sort_c=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("A_SORT_C ".concat(n," ").concat(e))]}})})},t.prototype.del=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("DEL ".concat(n))]}})})},t.prototype.exists=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("EXISTS ".concat(n))]}})})},t.prototype.expire=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("EXPIRE ".concat(n," ").concat(e))]}})})},t.prototype.flushAll=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("FLUSHALL")]}})})},t.prototype.get=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("GET ".concat(n))]}})})},t.prototype.set=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("SET ".concat(n," ").concat(e))]}})})},t.prototype.set_cb=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("SET_CB ".concat(n," ").concat(e))]}})})},t.prototype.set_cbf=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("SET_CBF ".concat(n," ").concat(e))]}})})},t.prototype.set_cf=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("SET_CF ".concat(n," ").concat(e))]}})})},t.prototype.keys=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("KEYS ".concat(n))]}})})},t.prototype.obj_new=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("O_NEW ".concat(n))]}})})},t.prototype.obj_get=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("O_GET ".concat(n," ").concat(e))]}})})},t.prototype.obj_get_del=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("O_GET_SET ".concat(n," ").concat(e))]}})})},t.prototype.obj_set=function(n,e,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("O_SET ".concat(n," ").concat(e," ").concat(r))]}})})},t.prototype.obj_sort_c=function(n,e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("O_SORT_C ".concat(n," ").concat(e))]}})})},t.prototype.ping=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("PING ".concat(n))]}})})},t.prototype.ttl=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.authenticate()];case 1:return t.sent(),[2,this.sendCommand("TTL ".concat(n))]}})})},t}(events_1.EventEmitter);exports.ServerSocketDatabaseInMemoryClientAuth=ServerSocketDatabaseInMemoryClientAuth;